'use strict';

var SAPPassport = require('@sap/e2e-trace').Passport;
var Logger = require('./logging-tools/Logger');
var Tracer = require('./logging-tools/Tracer');

module.exports = RequestContext;

function RequestContext(appContext, req, id) {
  this._appContext = appContext;
  this._req = req;
  this._id = (id === null || id === undefined) ? appContext._idGenerator.nextId() : id;
  if (req && req.headers[SAPPassport.HEADER_NAME]) {
    this._passportFields = new SAPPassport(req.headers[SAPPassport.HEADER_NAME]).readUniqueIdentifiers();
  }
}

RequestContext.prototype.getLogger = function (category) {
  return new Logger(this, category);
};

RequestContext.prototype.getTracer = function () {
  return new Tracer(this);
};

RequestContext.prototype._shorten = function () {
  var req = this._req;
  return {
    _appContext: this._appContext._shorten(),
    _id: this._id,
    _user: req && req.user && req.user.id,
    _sessionId: req && req.session && req.session.id,
    _passportFields: this._passportFields
  };
};
